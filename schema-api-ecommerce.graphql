# Custom Scalar Types
"""
ISO-8601 UTC DateTime (e.g. 2026-02-06T15:30:00Z)
"""
scalar DateTime

enum Role {
  CLIENT
  MANAGER
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum PaymentMethod {
  PAYMENT_LINK
  PAYMENT_INTENT
}

# ─────────────────────────────────────────────────
# OBJECT TYPES
# ─────────────────────────────────────────────────

type Address {
  id: ID!
  addressLine: String!
  city: String!
  country: String!
  postalCode: String!
}

type User {
  id: ID!
  email: String!
  fullName: String
  role: Role!
  addresses: [Address!]
}

type Category {
  id: ID!
  name: String!
  products: [Product!]
}

type Product {
  id: ID!
  name: String!
  description: String!
  categories: [Category!]!
  featuredImage: Image
  images: [Image!]!
  options: [ProductOption!]!
  variants: [Variant!]!
  """
  Whether product is active and visible to customers
  """
  isActive: Boolean!
  """
  Soft delete timestamp (null if not deleted)
  """
  deletedAt: DateTime
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""
Product option (e.g., Color with values ["Red", "Blue"])
"""
type ProductOption {
  id: ID!
  """
  Option name (e.g., "Color", "Size")
  """
  name: String!
  """
  Available values (e.g., ["S", "XL", "L"])
  """
  values: [String!]!
}

type Variant {
  id: ID!
  """
  Unique stock keeping unit
  """
  sku: String!
  price: Int!
  stockQuantity: Int!
  product: Product!
  image: Image
  """
  Selected options for this variant (e.g., Color: Red, Size: M)
  """
  selectedOptions: [SelectedOption!]!
  """
  Whether the authenticated user has liked this variant.
  Always false for unauthenticated requests.
  """
  isFavorite: Boolean!
  paymentLinkUrl: String
}

type SelectedOption {
  """
  Option name (e.g., "Color")
  """
  name: String!
  """
  Selected value (e.g., "Red")
  """
  value: String!
}

type Image {
  id: ID!
  url: String!
  isMain: Boolean!
}

type Favorite {
  id: ID!
  variant: Variant!
  createdAt: DateTime!
}

type CartItem {
  id: ID!
  quantity: Int!
  variant: Variant!
  """
  Subtotal for this item (price × quantity)
  """
  subtotal: Int!
}

type Cart {
  id: ID!
  items: [CartItem!]!
  totalQuantity: Int!
  """
  Sum of all item subtotals
  """
  subtotal: Int!
  """
  Final total (currently same as subtotal, placeholder for tax/discount)
  """
  grandTotal: Int!
}

type Order {
  id: ID!
  status: OrderStatus!
  """
  Sum of items before discount
  """
  subtotal: Int!
  """
  Discount amount applied (0 if none)
  """
  discountAmount: Int!
  """
  Final total after discount
  """
  totalAmount: Int!
  """
  Snapshot of shipping address at time of order
  """
  shippingAddress: Address!
  items: [OrderItem!]!
  payments: [Payment!]!
  createdAt: DateTime!
}

"""
Order item with snapshot data (product/variant details at time of purchase)
"""
type OrderItem {
  id: ID!
  """
  Product title at time of purchase
  """
  productTitle: String!
  """
  Variant title at time of purchase
  """
  variantTitle: String!
  quantity: Int!
  """
  Unit price at time of purchase
  """
  price: Int!
  """
  Total for this line item (price × quantity)
  """
  total: Int!
}

type Payment {
  id: ID!
  amount: Int!
  paymentMethod: PaymentMethod!
  status: PaymentStatus!
  """
  Stripe receipt URL (if available)
  """
  receiptUrl: String
  createdAt: DateTime!
}

# ─────────────────────────────────────────────────
# ROOT QUERY
# ─────────────────────────────────────────────────

type Query {
  # --- PUBLIC ---
  product(id: ID!): Product
  products(limit: Int = 15, offset: Int = 0, categoryId: ID): PaginatedProducts!
  categories: [Category!]!

  # --- AUTHENTICATED USER ---
  me: User
  myCart: Cart
  myFavorites: [Favorite!]!

  # --- UNIFIED QUERIES (Filtered by role) ---

  """
  Get a specific order by ID.
  Access is determined by user role.
  """
  order(id: ID!): Order

  """
  Get orders with optional filters.
  - Clients see their own orders.
  - Managers see all orders.
  """
  orders(
    filter: OrderFilterInput
    limit: Int = 20
    offset: Int = 0
  ): PaginatedOrders!
}

# ─────────────────────────────────────────────────
# PAGINATION
# ─────────────────────────────────────────────────

type PaginatedProducts {
  items: [Product!]!
  page: Int!
  limit: Int!
  totalItems: Int!
  totalPages: Int!
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
}

type PaginatedOrders {
  items: [Order!]!
  page: Int!
  limit: Int!
  totalItems: Int!
  totalPages: Int!
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
}

# ─────────────────────────────────────────────────
# ROOT MUTATIONS
# ─────────────────────────────────────────────────

type Mutation {
  # AUTH
  signUp(input: SignUpInput!): AuthPayload!
  signIn(input: SignInInput!): AuthPayload!
  signOut(token: String!): Boolean!
  forgotPassword(email: String!): Boolean!
  resetPassword(input: ResetPasswordInput!): Boolean!
  refreshToken(token: String!): AuthPayload!
  changePassword(input: ChangePasswordInput!): Boolean!

  # ADDRESSES
  addAddress(input: CreateAddressInput!): Address!
  updateAddress(id: ID!, input: UpdateAddressInput!): Address!
  deleteAddress(id: ID!): Address!

  # FAVORITES
  toggleFavorite(variantId: ID!): Boolean!

  # CATEGORIES (manager)
  """
  Create category. Requires MANAGER role.
  """
  createCategory(input: CreateCategoryInput!): Category!
  updateCategory(id: ID!, input: UpdateCategoryInput): Category!
  """
  Soft delete category. Returns deleted category.
  Requires MANAGER role.
  """
  deleteCategory(id: ID!): Category!

  # PRODUCTS (manager)
  """
  Create new product with variants.
  Requires MANAGER role.
  """
  createProduct(input: CreateProductInput!): Product!
  """
  Update product details.
  Does not affect variants or images.
  Requires MANAGER role.
  """
  updateProduct(id: ID!, input: UpdateProductInput!): Product!
  """
  Soft delete product. Returns deleted product.
  Requires MANAGER role.
  """
  deleteProduct(id: ID!): Product!
  """
  Disable product (sets isActive = false).
  Requires MANAGER role.
  """
  disableProduct(id: ID!): Product!
  """
  Enable product (sets isActive = true).
  Requires MANAGER role.
  """
  enableProduct(id: ID!): Product!

  # VARIANTS (manager)
  """
  Add new variant to existing product.
  Requires MANAGER role.
  """
  addVariant(productId: ID!, input: CreateVariantInput!): Product!
  """
  Update existing product variant.
  Requires MANAGER role.
  """
  updateVariant(id: ID!, input: UpdateVariantInput!): Product!
  """
  Delete product variant. Returns updated product.
  Requires MANAGER role.
  """
  deleteVariant(id: ID!): Product!

  # IMAGES (manager)
  """
  Add image to product gallery.
  Requires MANAGER role.
  """
  addProductImage(id: ID!, input: AddImageInput): Product!
  """
  Delete image from product gallery.
  Requires MANAGER role.
  """
  deleteProductImage(id: ID!): Product!

  # CART (client)
  """
  Add item to cart.
  If variant already exists in cart, increases quantity.
  Creates cart on first use.
  """
  addItemToCart(input: AddToCartInput!): Cart!
  """
  Update cart item quantity.
  Quantity must be >= 1. Use removeItemFromCart to delete items.
  """
  updateCartItemQuantity(id: ID!, quantity: Int!): Cart!
  """
  Remove item from cart.
  """
  removeItemFromCart(id: ID!): Cart!
  """
  Remove all items from cart.
  """
  clearCart: Cart!

  # CHECKOUT (client)
  """
  Create order from current cart.
  Clears cart items on success.
  """
  checkout(input: CheckoutInput!): Order!

  # ORDER STATUS
  """
  Update order status.
  Manager: paid → processing → shipped.
  Enforced by role.
  """
  updateOrderStatus(id: ID!, status: OrderStatus!): Order!

  """
  Cancel an order.
  Only allowed before shipped status.
  Client can cancel own orders.
  """
  cancelOrder(id: ID!): Order!

  # PAYMENT
  """
  Create Stripe payment intent for order.
  Returns client secret for Stripe frontend confirmation.
  """
  createPaymentIntent(orderId: ID!): PaymentIntentResult!
}

# ─────────────────────────────────────────────────
# INPUT TYPES
# ─────────────────────────────────────────────────

# Auth
input SignUpInput {
  fullName: String!
  email: String!
  password: String!
}

input SignInInput {
  email: String!
  password: String!
}

input ResetPasswordInput {
  """
  Token from password reset email
  """
  token: String!
  newPassword: String!
}

input ChangePasswordInput {
  oldPassword: String!
  newPassword: String!
}

# User / Addresses
input CreateAddressInput {
  addressLine: String!
  city: String!
  country: String!
  postalCode: String!
}

input UpdateAddressInput {
  addressLine: String
  city: String
  country: String
  postalCode: String
}

# Categories
input CreateCategoryInput {
  name: String!
}

input UpdateCategoryInput {
  name: String
}

# Products
input CreateProductInput {
  title: String!
  description: String!
  categoryId: ID!
  """
  Image URLs for product gallery
  """
  images: [String!]
  """
  Product options (e.g., [{name: "Color", values: ["Red", "Blue"]}])
  """
  options: [ProductOptionInput!]!
  """
  Product variants (at least one required)
  """
  variants: [CreateVariantInput!]!
}

input UpdateProductInput {
  title: String
  description: String
  categoryId: ID
}

# Variants
input ProductOptionInput {
  """
  Option name (e.g., "Color", "Size")
  """
  name: String!
  """
  Available values (e.g., ["Red", "Blue", "Green"])
  """
  values: [String!]!
}

input CreateVariantInput {
  sku: String!
  """
  Price in cents (e.g., 2000 = $20.00)
  """
  price: Int!
  stock: Int!
  selectedOptions: [SelectedOptionInput!]!
  imageUrl: String
}

input UpdateVariantInput {
  sku: String
  price: Int
  stock: Int
  imageUrl: String
}

input SelectedOptionInput {
  """
  Option name (must match ProductOption.name)
  """
  name: String!
  """
  Option value (must be in ProductOption.values)
  """
  value: String!
}

# Images
input AddImageInput {
  url: String!
}

# Cart
input AddToCartInput {
  variantId: ID!
  """
  Quantity to add (default: 1)
  """
  quantity: Int! = 1
}

# Checkout
input CheckoutInput {
  """
  Shipping address for this order
  """
  shippingAddressId: ID!
}

input OrderFilterInput {
  """
  Filter by current order status.
  """
  status: OrderStatus

  """
  Date range: start date (ISO 8601, e.g. "2026-02-01T00:00:00Z")
  """
  startDate: String

  """
  Date range: end date (ISO 8601)
  """
  endDate: String

  """
  Price range: minimum total paid
  """
  minPrice: Float

  """
  Price range: maximum total paid
  """
  maxPrice: Float
}

# ─────────────────────────────────────────────────
# RESPONSE TYPES
# ─────────────────────────────────────────────────

type AuthPayload {
  """
  JWT access token (expires in 15 minutes)
  """
  accessToken: String!
  user: User!
}

type PaymentIntentResult {
  """
  Stripe client secret for frontend confirmation
  """
  clientSecret: String!
  amount: Int!
}
